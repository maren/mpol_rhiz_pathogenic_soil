---
title: "soil whiz"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, message = F}
library(ggplot2)
library(reshape2)
library(plyr)
library(dplyr)
library(car)
library(multcomp)
library(data.table)
library(lme4)
library(lmerTest)

SRMort <- read.csv("Soil_Rhiz_All_Data20Feb2018.csv")




# Now doing the same thing for the Trapping experiment
TrapMort <- read.csv("Trapping_Alll_Data20Feb2018.csv")


# ====== Beginning actual data analysis and figures for results sections =====

# Trapping Exp: Mortality ====
MortMod <- glmer(as.factor(Dead_0) ~ Treat * Range + (1 | Genotype), family = binomial(link = "logit"), data = TrapMort)
lmerTest::anova(MortMod, test = "Chisq") # Doesn't work
car::Anova(MortMod) # works


MortMod2 <- glmer(as.factor(Dead_0) ~ Treatment * Range + (1 | Genotype), family = binomial(link = "logit"), data = TrapMort)
car::Anova(MortMod2) # This shows significance but it runs out of DFs...

MM <- glm(as.factor(Dead_0) ~ Treatment * Range, family = binomial(link = "logit"), data = TrapMort)
anova(MM, test = "Chisq")

MortMod3 <- glmer(as.factor(Dead_0) ~ Treatment  + (1 | Genotype), family = binomial(link = "logit"), data = TrapMort)

car::Anova(MortMod3) # works

ggplot(TrapMort, aes(x = Treatment, y = Dead_0, colour = Treat)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Treatment", y = "Survival Rate", title = "Trapping Experiment Mortality 21 Feb 2018")
ggsave(file = "SurvivalRateTrapExp21Feb2018.pdf")

summary(glht(MortMod3, mcp(Treatment = "Tukey"))) # NS between Soil treatments, only soil and buffer/wsm

ddply(TrapMort, "Treatment", summarise, Mean = mean(Dead_0))
ddply(TrapMort, "Treat", summarise, Mean = mean(Dead_0))

# Trapping Exp: Biomass Data ====

# Manually fixed some errors in the csv file
TrapMort <- read.csv("Trapping_Alll_Data20Feb2018.csv")
# Only the buffer and WSM plants were harvested
TrapBio <- subset(TrapMort, Treat != "Soil")

# Shoot Data
ShootMod <- lmer(ShootWeight ~ Treatment * Range + (1| Genotype), data = TrapBio)
anova(ShootMod)
ggplot(TrapBio, aes(x = Treatment, y = ShootWeight, colour = Range)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Treatment", y = "Shoot Weight (mg)", title = "Trapping Experiment Shoot Weight 21 Feb 2018") 
#ggsave(file = "TrappingShootWeight21Feb2018.pdf")

# Root Data
RootMod <- lmer(RootWeight ~ Treatment * Range + (1| Genotype), data = TrapBio)
anova(RootMod)
ggplot(TrapBio, aes(x = Treatment, y = RootWeight, colour = Range)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Treatment", y = "Root Weight (mg)", title = "Trapping Experiment Root Weight 21 Feb 2018") 
#ggsave(file = "TrappingRootWeight21Feb2018.pdf")

# Nodule Data
#   Number
NNMod <- lmer(NodNum ~ Range + (1| Genotype), data = TrapBio)
anova(NNMod)
ggplot(TrapBio, aes(x = Range, y = NodNum)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Treatment", y = "Nodule Number", title = "Trapping Experiment Nodule Number 21 Feb 2018")  + coord_cartesian(ylim = c(0,30))
#ggsave(file = "TrappingNoduleNumber21Feb2018.pdf") 

#   Weight
NWMod <- lmer(NodWeight ~ Range + (1| Genotype), data = TrapBio)
anova(NWMod)
ggplot(TrapBio, aes(x = Range, y = NodWeight)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Treatment", y = "Nodule Weight (mg)", title = "Trapping Experiment Nodule Weight 21 Feb 2018")  + coord_cartesian(ylim = c(0,.0035))
#ggsave(file = "TrappingWeight21Feb2018.pdf")
SRMort <- within(SRMort, Soil <- as.factor(paste(SoilConc, Inoculate)))
# Soil x Rhiz Exp: Mortality ====
SRMort$Treatment <- as.factor(SRMort$Treatment)
SRMortMod <- glm(DeadOrAlive ~ Treatment , family = binomial(link = "logit"), data = SRMort)
anova(SRMortMod, test = "Chisq")
summary(glht(SRMortMod, mcp(Treatment = "Tukey"))) # NS between Soil treatments, only soil and buffer/wsm


SRMort$Survival <- ifelse(SRMort$DeadOrAlive == "Alive", 1,0)
ggplot(SRMort, aes(x = Treatment, y = Survival, colour = Inoculate, shape = SoilLocation)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Treatment", y = "Survival Rate", title = "SxR Experiment Mortality 21 Feb 2018") + facet_grid(. ~ SoilConc, scales = "free_x")

ggplot(SRMort, aes(x = SoilConc, y = Survival, colour = Inoculate)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Soil Concentration", y = "Survival Rate", title = "SxR Experiment Mortality 21 Feb 2018") #+ facet_grid(. ~ Match, scales = "free_x")
#ggsave(file = "SurvivalRateSRExperiment21Feb2018.pdf")


ggplot(SRMort, aes(x = Soil, y = Survival)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Soil Concentration", y = "Survival Rate", title = "SxR Experiment Mortality 21 Feb 2018") + facet_grid(. ~ Range, scales = "free_x")

ggplot(SRMort, aes(x = Soil, y = Survival, shape = Match)) + stat_summary(fun.data = "mean_se") + theme_classic() + labs(x = "Soil Concentration", y = "Survival Rate", title = "SxR Experiment Mortality 21 Feb 2018") + facet_grid(. ~ Range, scales = "free_x")

SRMortMod2 <- glm(DeadOrAlive ~ SoilConc * Inoculate , family = binomial(link = "logit"), data = SRMort)
anova(SRMortMod2, test = "Chisq")
```


